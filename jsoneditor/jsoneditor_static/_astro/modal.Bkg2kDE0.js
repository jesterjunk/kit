import{r as D,R as M}from"./index.BqJQxrZM.js";import{c as R,y as z,B as a,z as H,j as l,C as j,E as K,f as b}from"./debug.DRjTZKen.js";import{j as C}from"./jsx-runtime.D_zvdyIk.js";function x(e){return typeof e=="object"&&e!==null&&(e.constructor===void 0||e.constructor.name==="Object")}function U(e){return x(e)&&typeof e.text=="string"}function _(e,t=void 0,n=JSON){return U(e)?e:{text:n.stringify(e.json,null,t)}}function re(e,t){return q(e,t)>t}function q(e,t=1/0){if(U(e))return e.text.length;const n=e.json;let o=0;function r(s){if(Array.isArray(s)){if(o+=2+(s.length-1),o>t)return o;for(let u=0;u<s.length;u++){const h=s[u];if(r(h),o>t)return o}}else if(x(s)){const u=Object.keys(s);o+=2+u.length+(u.length-1);for(let h=0;h<u.length;h++){const T=u[h],V=s[T];o+=T.length+2,r(V)}}else typeof s=="string"?o+=s.length+2:o+=String(s).length}return r(n),o}function ae(e,t){return e.parse===t.parse&&e.stringify===t.stringify}class w extends Error{}w.prototype.name="InvalidTokenError";function G(e){return decodeURIComponent(atob(e).replace(/(.)/g,(t,n)=>{let o=n.charCodeAt(0).toString(16).toUpperCase();return o.length<2&&(o="0"+o),"%"+o}))}function J(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return G(t)}catch{return atob(t)}}function B(e,t){if(typeof e!="string")throw new w("Invalid token specified: must be a string");t||(t={});const n=t.header===!0?0:1,o=e.split(".")[n];if(typeof o!="string")throw new w(`Invalid token specified: missing part #${n+1}`);let r;try{r=J(o)}catch(s){throw new w(`Invalid token specified: invalid base64 for part #${n+1} (${s.message})`)}try{return JSON.parse(r)}catch(s){throw new w(`Invalid token specified: invalid json for part #${n+1} (${s.message})`)}}function ie(e){return!!e&&typeof e.message=="string"&&Array.isArray(e.reasons)}function v({message:e,reasons:t,status:n}){const o=new Error(e);return o.reasons=t,o.status=n,o}const p=1e3*1e3;function W(e,t){try{const n=window.localStorage[e];return n!==void 0?JSON.parse(n):t}catch(n){return console.error("error in function loadProperty  "+n.message),t}}function E(e,t){const n=JSON.stringify(t),o=n.length;try{return o<=p?(window.localStorage[e]=n,{success:!0,error:null,size:o,maxSize:p}):{success:!1,error:"Error: Value too large to store in local storage",size:o,maxSize:p}}catch(r){return console.error("error in function saveProperty  "+r.message),{success:!1,error:String(r),size:o,maxSize:p}}}function F(e){try{delete window.localStorage[e]}catch(t){console.error("error in function removeProperty  "+t.message)}}const g=R("jsoneditoronline:rest"),I=["Did you or someone else delete this cloud document?","Is the id of the document correct or is there a typo?"];async function ce(e){const[t,n]=await Promise.all([Y(e),X(e)]);return{document:t,contentText:n}}async function Y(e){const t=await window.fetch(`${a}/v2/docs/${e}`,{method:"GET",headers:{...await c()}});return await i(t,n=>d(`Failed to load document with id "${e}". ${n}.`,t.status,I)),t.json()}async function ue(){const e=await window.fetch(`${a}/v2/docs/list/currentUser`,{method:"GET",headers:{...await c()}});return await i(e,t=>v({message:`Failed to load your cloud documents. ${t}.`,reasons:[],status:e.status})),e.json()}async function de(e){if(!await c())return[];const n=await window.fetch(`${a}/v2/docs/list/currentUser/ids`,{method:"PATCH",headers:{"content-type":"application/json",...await c()},body:JSON.stringify(e)});return await i(n,o=>v({message:`Failed to patch your cloud document ids. ${o}.`,reasons:[],status:n.status})),n.json()}async function X(e){const t=await window.fetch(`${a}/v2/docs/${e}/data`,{method:"GET",headers:{...await c()}});return await i(t,n=>d(`Failed to load document with id "${e}". ${n}.`,t.status,I)),t.text()}function d(e,t,n=[]){return v({message:e,reasons:t===401?["Do you have to sign in again?"]:t===403?["You do not have access, is this document yours?"]:n,status:t})}async function le(e){if(!e)return;const t=await window.fetch(e,{method:"GET"});return await i(t,n=>d(`Failed to load url "${e}". ${n}.`,t.status)),t.json()}async function he(e,t,n,o){const r=await window.fetch(`${a}/v2/docs/${e}/data`,{method:"PUT",headers:{"Content-Type":"application/json",...await c()},body:_(t,o,n).text});return await i(r,s=>d(`Failed to save document with id "${e}". ${s}.`,r.status)),r.json()}async function fe(e,t){const n=await window.fetch(`${a}/v2/docs/${e}/name`,{method:"PUT",headers:{"Content-Type":"text/plain",...await c()},body:t});return await i(n,o=>d(`Failed to update name of document with id "${e}". ${o}.`,n.status)),n.json()}async function we(e,t,n,o){const r=await window.fetch(`${a}/v2/docs/${e}/schema`,{method:"PUT",headers:{"Content-Type":"application/json",...await c()},body:n.stringify(t,null,o)});return await i(r,s=>d(`Failed to update schema of document with id "${e}". ${s}.`,r.status)),r.json()}async function me(e,t){const n=await window.fetch(`${a}/v2/docs/${e}/access`,{method:"PUT",headers:{"Content-Type":"application/json",...await c()},body:JSON.stringify(t)});return await i(n,o=>d(`Failed to update access of document with id "${e}". ${o}.`,n.status)),n.json()}async function pe(e,t,n,o,r){const s=await window.fetch(`${a}/v2/docs?name=`+encodeURIComponent(e)+"&schemaConfig="+encodeURIComponent(JSON.stringify(n)),{method:"POST",headers:{"Content-Type":"application/json",...await c()},body:_(t,r,o).text});return await i(s,u=>d(`Failed to save document. ${u}.`,s.status)),s.json()}async function ge(e){const t=await window.fetch(`${a}/v2/docs/${e}/forget`,{method:"PUT",headers:{...await c()}});return await i(t,n=>d(`Failed to forget document with id ${e}". ${n}.`,t.status)),t.json()}async function ye(e){const t=await window.fetch(`${a}/v2/docs/${e}`,{method:"DELETE",headers:{...await c()}});return await i(t,n=>d(`Failed to delete document with id ${e}". ${n}.`,t.status)),t.json()}async function $e(e){const t=await window.fetch(e);return await i(t,n=>Error(`Failed to load url. ${n}.`)),await t.text()}async function i(e,t){if(e.status<200||e.status>=300){let n;try{n=(await e.json())?.message}catch{}throw t(n||"")}}async function c(){const e=await P();return e?{authorization:e.tokenType+" "+e.accessToken}:void 0}async function P(){const e=O();if(!e)return null;const t=new Date(e.expiresAt);if(Date.now()+H<t.valueOf())return e;if(f)return await f;{f=Z(e);const n=await f;return f=null,n}}let f=null;async function Z(e){try{g("Refreshing auth token...");const t=await window.fetch(`${a}/v2/auth/token?refresh_token=${encodeURIComponent(e.refreshToken)}`);await i(t,r=>Error(`Failed to load url. ${r}.`));const n=await t.json(),o=Q(n);return g("Auth token refreshed",n),E(l,o),o}catch(t){return console.error("Failed to refresh auth token",{error:t}),null}}async function ve(e){g("Deleting user account...");const t=await window.fetch(`${a}/v2/auth/currentUser/deleteAccount?id=${e}`,{method:"DELETE",headers:{...await c()}});await i(t,o=>Error(`Failed to fetch url. ${o}.`));const n=await t.json();return F(l),g("User account deleted",n),n}function O(){return W(l)||null}function A(e){return e?B(e.accessToken):null}function Ee(e){return e.subscriptions.some(t=>N(t))}function Ae(e){return e.subscriptions.some(t=>N(t)&&z.includes(t.plan.id))}function N(e){return e.active&&(typeof e.expiresAt=="number"?Date.now()<e.expiresAt*1e3:!0)}function Q(e,t=Date.now()){return{accessToken:e.access_token,refreshToken:e.refresh_token,expiresAt:new Date(t+e.expires_in*1e3).toISOString(),tokenType:e.token_type}}function Te(){window.location.href=`${j}/register`}function De(){const e=location.origin+location.pathname+"#/callback";window.location.href=`${a}/v2/auth/sign_in?redirect_url=${encodeURIComponent(e)}`}function be(){F(l),window.location.href=`${a}/v2/auth/sign_out`}function Ce(){window.location.href=`${j}/account`}const k=R("jsoneditoronline:useAuth"),m=[];let y;function ee(e){m.push(e),y||L()}function te(e){const t=m.findIndex(n=>n===e);m.splice(t,1),m.length===0&&clearTimeout(y)}function $(e){m.forEach(t=>t(e))}function ke(e){E(l,e),$({user:A(e),error:null})}function L(){k("refreshAuth"),window.clearTimeout(y),P().then(e=>{E(l,e);const t=A(e);k("refreshed user",t),$({user:t,error:null})}).catch(e=>{console.error("refreshing user failed",e),$({user:null,error:e})}).finally(()=>{y=window.setTimeout(L,K)})}function Se(){const[e,t]=D.useState({user:A(O()),error:null});return D.useEffect(()=>(ee(t),()=>te(t)),[]),e}class Re extends M.PureComponent{constructor(t){super(t),this.backgroundRef=null,this.handleRequestClose=this.handleRequestClose.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this),this.close=this.close.bind(this)}render(){return C.jsx("div",{ref:t=>{this.backgroundRef=t},className:b("modal-background",this.props.className),onPointerDown:this.handleRequestClose,children:C.jsx("div",{className:b("modal-foreground",this.props.className),children:this.props.children})})}componentDidMount(){window.addEventListener("keydown",this.handleKeyDown),document.activeElement&&typeof document.activeElement.blur=="function"&&document.activeElement.blur()}componentWillUnmount(){window.removeEventListener("keydown",this.handleKeyDown)}handleRequestClose(t){t.target===this.backgroundRef&&(t.preventDefault(),t.stopPropagation(),this.props.onRequestClose())}handleKeyDown(t){t.which===27&&(t.preventDefault(),t.stopPropagation(),clearTimeout(S),S=setTimeout(()=>this.props.onRequestClose(),0))}close(){this.componentWillUnmount()}}let S=null;export{ae as A,Ae as B,ve as C,be as D,Ce as E,Te as F,le as G,ue as H,Re as M,ce as a,ge as b,v as c,ye as d,me as e,$e as f,P as g,we as h,ie as i,pe as j,he as k,W as l,x as m,De as n,Q as o,de as p,ke as q,F as r,E as s,_ as t,fe as u,O as v,Se as w,Ee as x,U as y,re as z};
